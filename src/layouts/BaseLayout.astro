---
import { getCollection } from 'astro:content';
import ContactModal from '../components/ContactModal.astro';

interface Props {
  title: string;
  description?: string;
  showProfile?: boolean;
  profileData?: {
    name: string;
    title: string;
    image: string;
    socialLinks: {
      linkedin: string;
      github: string;
      email: string;
    };
  };
}

const { title, description = "Personal website", showProfile = false, profileData } = Astro.props;

// Get all pages for navigation
const allPages = await getCollection('pages');
const navPages = allPages
  .filter(p => !p.data.draft && !p.data.hideFromNav)
  .sort((a, b) => (a.data.navOrder ?? 999) - (b.data.navOrder ?? 999));

// Determine current page for navigation highlighting
const currentPath = Astro.url.pathname;
---

<!doctype html>
<html class="scroll-smooth" lang="en-GB">
  <head>
    <meta charset="UTF-8" />
    <meta name="description" content={description} />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    
    <!-- Favicons -->
    <link rel="icon" type="image/x-icon" href="/favicon.ico" />
    <link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png" />
    <link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png" />
    <link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png" />
    <link rel="manifest" href="/site.webmanifest" />
    
    <meta name="generator" content={Astro.generator} />
    <title>{title}</title>
    <link rel="stylesheet" href="/src/styles/global.css" />
    
    <script is:inline>
      const systemPref = window.matchMedia("(prefers-color-scheme: light)");

      function getStoredMode() {
        const stored = typeof localStorage !== "undefined" && localStorage.getItem("color-mode");
        return stored || (systemPref.matches ? "light" : "dark");
      }

      function applyMode(mode) {
        if (mode !== "light" && mode !== "dark") {
          return console.warn(`Invalid mode: ${mode}`);
        }

        const root = document.documentElement;

        if (mode === root.getAttribute("data-mode")) {
          return;
        }

        root.setAttribute("data-mode", mode);

        if (typeof localStorage !== "undefined") {
          localStorage.setItem("color-mode", mode);
        }
      }

      applyMode(getStoredMode());

      document.addEventListener("astro:after-swap", () => applyMode(getStoredMode()));

      document.addEventListener("mode-toggle", (e) => {
        applyMode(e.detail.mode);
      });

      systemPref.addEventListener("change", (e) => applyMode(e.matches ? "light" : "dark"));
    </script>
  </head>
  <body class="bg-bg-base text-text-primary mx-auto flex min-h-screen max-w-3xl flex-col px-4 pt-16 font-mono text-sm font-normal antialiased sm:px-8">
    <header class="group relative mb-10 flex items-center justify-end" id="site-header">
      <nav aria-label="Primary navigation" class="flex gap-6 relative" id="main-nav">
        <a href="/" class:list={["nav-link", "transition-colors", "hover:text-[var(--color-brand)]", { "current-page": currentPath === "/" }]}>
          home
        </a>
        {navPages.map(page => (
          <a 
            href={`/${page.slug}`} 
            class:list={["nav-link", "transition-colors", "hover:text-[var(--color-brand)]", { "current-page": currentPath === `/${page.slug}` || currentPath === `/${page.slug}/` }]}
          >
            {page.data.navLabel || page.slug}
          </a>
        ))}
        <button id="contact-button" class="nav-link transition-colors hover:text-[var(--color-brand)]" type="button">
          contact
        </button>
        <span class="nav-underline" aria-hidden="true"></span>
      </nav>
    </header>
    
    <theme-switch class="fixed bottom-8 right-8 z-50">
      <button class="relative h-9 w-9 cursor-pointer rounded-md p-2 transition-colors hover:text-[var(--color-accent-secondary)]" type="button">
        <span class="sr-only">Toggle color mode</span>
        <svg
          aria-hidden="true"
          class="absolute inset-0 m-auto h-8 w-8 opacity-0 transition-opacity duration-200 dark:opacity-100"
          fill="none"
          focusable="false"
          stroke="currentColor"
          stroke-width="2"
          stroke-linecap="round"
          stroke-linejoin="round"
          viewBox="0 0 24 24"
          xmlns="http://www.w3.org/2000/svg"
        >
          <circle cx="12" cy="12" r="4"/>
          <path d="M12 3v1"/>
          <path d="M12 20v1"/>
          <path d="M3 12h1"/>
          <path d="M20 12h1"/>
          <path d="m18.364 5.636-.707.707"/>
          <path d="m6.343 17.657-.707.707"/>
          <path d="m5.636 5.636.707.707"/>
          <path d="m17.657 17.657.707.707"/>
        </svg>
        <svg
          aria-hidden="true"
          class="absolute inset-0 m-auto h-8 w-8 opacity-100 transition-opacity duration-200 dark:opacity-0"
          fill="none"
          focusable="false"
          stroke="currentColor"
          stroke-width="2"
          stroke-linecap="round"
          stroke-linejoin="round"
          viewBox="0 0 24 24"
          xmlns="http://www.w3.org/2000/svg"
        >
          <path d="M12 3a6 6 0 0 0 9 9 9 9 0 1 1-9-9Z"/>
          <path d="M19 3v4"/>
          <path d="M21 5h-4"/>
        </svg>
      </button>
    </theme-switch>

    <main id="main" class="pb-24">
      {showProfile && profileData && (
        <section class="grid items-start gap-8 sm:grid-cols-[9rem_1fr]">
          <img src={profileData.image} alt={`${profileData.name} profile picture`} class="h-34 w-34 rounded-full object-cover sm:h-50 sm:w-56" />
          <div>
          <br>
            <h1 class="page-title mb-2">{profileData.name}</h1>
            <p class="mb-6 text-lg text-text-primary/70">{profileData.title}</p>
            
            <div class="flex flex-wrap items-end gap-x-2">
              <ul class="flex items-center gap-x-2">
                <li class="flex">
                  <a
                    class="hover:text-link inline-block"
                    href={profileData.socialLinks.linkedin}
                    rel="noreferrer"
                    target="_blank"
                    aria-label="LinkedIn"
                  >
                    <svg aria-hidden="true" class="h-6 w-6" focusable="false" viewBox="0 0 24 24" fill="currentColor">
                      <path d="M20.447 20.452h-3.554v-5.569c0-1.328-.027-3.037-1.852-3.037-1.853 0-2.136 1.445-2.136 2.939v5.667H9.351V9h3.414v1.561h.046c.477-.9 1.637-1.85 3.37-1.85 3.601 0 4.267 2.37 4.267 5.455v6.286zM5.337 7.433c-1.144 0-2.063-.926-2.063-2.065 0-1.138.92-2.063 2.063-2.063 1.14 0 2.064.925 2.064 2.063 0 1.139-.925 2.065-2.064 2.065zm1.782 13.019H3.555V9h3.564v11.452zM22.225 0H1.771C.792 0 0 .774 0 1.729v20.542C0 23.227.792 24 1.771 24h20.451C23.2 24 24 23.227 24 22.271V1.729C24 .774 23.2 0 22.222 0h.003z"/>
                    </svg>
                    <span class="sr-only">LinkedIn</span>
                  </a>
                </li>
                <li class="flex">
                  <a
                    class="hover:text-link inline-block"
                    href={profileData.socialLinks.github}
                    rel="noreferrer"
                    target="_blank"
                    aria-label="GitHub"
                  >
                    <svg aria-hidden="true" class="h-6 w-6" focusable="false" viewBox="0 0 24 24" fill="currentColor">
                      <path d="M12 0c-6.626 0-12 5.373-12 12 0 5.302 3.438 9.8 8.207 11.387.599.111.793-.261.793-.577v-2.234c-3.338.726-4.033-1.416-4.033-1.416-.546-1.387-1.333-1.756-1.333-1.756-1.089-.745.083-.729.083-.729 1.205.084 1.839 1.237 1.839 1.237 1.07 1.834 2.807 1.304 3.492.997.107-.775.418-1.305.762-1.604-2.665-.305-5.467-1.334-5.467-5.931 0-1.311.469-2.381 1.236-3.221-.124-.303-.535-1.524.117-3.176 0 0 1.008-.322 3.301 1.23.957-.266 1.983-.399 3.003-.404 1.02.005 2.047.138 3.006.404 2.291-1.552 3.297-1.23 3.297-1.23.653 1.653.242 2.874.118 3.176.77.84 1.235 1.911 1.235 3.221 0 4.609-2.807 5.624-5.479 5.921.43.372.823 1.102.823 2.222v3.293c0 .319.192.694.801.576 4.765-1.589 8.199-6.086 8.199-11.386 0-6.627-5.373-12-12-12z"/>
                    </svg>
                    <span class="sr-only">GitHub</span>
                  </a>
                </li>
                <li class="flex">
                  <a
                    class="hover:text-link inline-block"
                    href={profileData.socialLinks.email}
                    rel="noreferrer"
                    aria-label="Email"
                  >
                    <svg aria-hidden="true" class="h-6 w-6" focusable="false" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                      <rect width="20" height="16" x="2" y="4" rx="2"/>
                      <path d="m22 7-8.97 5.7a1.94 1.94 0 0 1-2.06 0L2 7"/>
                    </svg>
                    <span class="sr-only">Email</span>
                  </a>
                </li>
              </ul>
            </div>
          </div>
        </section>
      )}

      <slot />
    </main>

    <ContactModal />

    <script>
      function isDarkMode() {
        return document.documentElement.getAttribute("data-mode") === "dark";
      }

      class ThemeSwitch extends HTMLElement {
        constructor() {
          super();
          const button = this.querySelector<HTMLButtonElement>("button");

          if (button) {
            button.setAttribute("role", "switch");
            button.setAttribute("aria-checked", String(isDarkMode()));

            button.addEventListener("click", () => {
              const toggleEvent = new CustomEvent("mode-toggle", {
                detail: {
                  mode: isDarkMode() ? "light" : "dark",
                },
              });
              document.dispatchEvent(toggleEvent);

              button.setAttribute("aria-checked", String(isDarkMode()));
            });
          } else {
            console.warn("ThemeSwitch: Button element not found");
          }
        }
      }

      customElements.define("theme-switch", ThemeSwitch);

      // Sliding underline navigation
      const nav = document.getElementById("main-nav");
      const links = nav.querySelectorAll(".nav-link");
      const underline = nav.querySelector(".nav-underline");
      const currentPage = nav.querySelector(".current-page");

      function setUnderlinePosition(link, instant = false) {
        const linkRect = link.getBoundingClientRect();
        const navRect = nav.getBoundingClientRect();
        
        if (instant) {
          underline.style.transition = 'none';
        }
        
        underline.style.left = `${linkRect.left - navRect.left}px`;
        underline.style.width = `${linkRect.width}px`;
        
        if (instant) {
          // Force reflow to apply the position immediately
          underline.offsetHeight;
          underline.style.transition = '';
        }
      }

      // Initialize underline position on current page (instantly, no animation)
      if (currentPage) {
        setUnderlinePosition(currentPage, true);
      }

      // Add hover listeners
      links.forEach(link => {
        link.addEventListener("mouseenter", () => {
          setUnderlinePosition(link);
        });
      });

      // Return to current page when not hovering
      nav.addEventListener("mouseleave", () => {
        if (currentPage) {
          setUnderlinePosition(currentPage);
        }
      });

      // Update on resize
      window.addEventListener("resize", () => {
        if (currentPage) {
          setUnderlinePosition(currentPage);
        }
      });

      // Contact button handler
      const contactButton = document.getElementById("contact-button");
      if (contactButton) {
        contactButton.addEventListener("click", () => {
          document.dispatchEvent(new CustomEvent("open-contact-modal"));
        });
      }
    </script>
  </body>
</html>

